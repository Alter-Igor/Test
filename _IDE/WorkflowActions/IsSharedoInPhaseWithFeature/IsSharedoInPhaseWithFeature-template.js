"use strict";

// src/NodeBased/WorkflowActions/IsSharedoInPhaseWithFeature/IsSharedoInPhaseWithFeature-template.ts
var connections = $model.Connections;
var configuration = $model.Configuration;
var workItemId = ctx[configuration.workItemIdVariable];
if (!workItemId) {
  throw new Error("Cannot progress work item - no work item id");
}
function validate() {
  if (!configuration.phaseFeature) {
    log.Error("Phase feature is not set");
    throw new Error("Phase feature is not set");
  }
  let req = {
    "search": {
      "page": { "page": 1, "rowsPerPage": 20 },
      "sort": { "direction": "ascending", "orderBy": "title" },
      "workItemIds": [workItemId]
    },
    "enrich": [
      { "path": "title" },
      { "path": "type.systemName" },
      { "path": "reference" },
      { "path": "phase.systemName" }
    ]
  };
  log.Information("Getting matter for work item " + workItemId);
  let httpResultFindByQuery = sharedo.http.post("/api/v1/public/workItem/findByQuery", req);
  log.Information("Got matter for work item " + workItemId);
  httpResultFindByQuery.success = true;
  if (!httpResultFindByQuery.success) {
    log.Error("Error");
    log.Information(JSON.stringify(httpResultFindByQuery));
    throw new Error("Failed to jump to phase - API returned '".concat(httpResultFindByQuery.status, "'"));
  }
  if (!httpResultFindByQuery.body || httpResultFindByQuery.body.totalCount == 0) {
    log.Error("Work item ".concat(workItemId, " not found"));
    throw new Error("Work item ".concat(workItemId, " not found"));
  }
  log.Information("Work item ".concat(workItemId, " found"));
  let typeSystemName = httpResultFindByQuery.body.results[0].data["type.systemName"];
  let currentPhase = httpResultFindByQuery.body.results[0].data["phase.systemName"];
  let title = httpResultFindByQuery.body.results[0].data["title"];
  log.Information("Type system name is ".concat(typeSystemName));
  log.Information("Current phase is ".concat(currentPhase));
  log.Information("Title is ".concat(title));
  log.Information("Getting phases on type ".concat(typeSystemName, " that have feature flag ").concat(configuration.phaseFeature, " enabled"));
  let httpResultFeature = sharedo.http.get("/api/featureframework/flags/".concat(configuration.phaseFeature, "/").concat(typeSystemName, "/enabledPhases"));
  if (!httpResultFeature.success) {
    log.Error("Error getting sub features for type ".concat(typeSystemName));
    log.Information(JSON.stringify(httpResultFeature));
    throw new Error("Failed to jump to phase - API returned '".concat(httpResultFeature.status, "'"));
  }
  if (!httpResultFeature.body || httpResultFeature.body.length == 0) {
    log.Information("No features found - returning false");
    return false;
  }
  let found = httpResultFeature.body.find((phase) => phase.toLowerCase() === currentPhase.toLowerCase());
  if (!found) {
    log.Information("Current phase ".concat(currentPhase, " is not in the list of phases with feature ").concat(configuration.phaseFeature));
    return false;
  }
  log.Information("Found ".concat(configuration.phaseFeature, " on ShareDo ").concat(workItemId, " and has been used on ").concat(currentPhase, " phase"));
  return true;
}
if (validate() === true) {
  log.Information("Phase is in lis - calling connection exists");
  if (connections.exists) {
    trigger.SubProcess(connections.exists.step).Now();
  }
} else {
  log.Information("Phase is not in list - calling connection [notExists]");
  if (connections.doesNotExist) {
    trigger.SubProcess(connections.doesNotExist.step).Now();
  } else {
    log.Warning("No connection [notExists] found");
  }
}
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL05vZGVCYXNlZC9Xb3JrZmxvd0FjdGlvbnMvSXNTaGFyZWRvSW5QaGFzZVdpdGhGZWF0dXJlL0lzU2hhcmVkb0luUGhhc2VXaXRoRmVhdHVyZS10ZW1wbGF0ZS50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiXG5pbXBvcnQgeyBDb25maWd1cmF0aW9uVHlwZSwgSHR0cFJlc3VsdFR5cGUsIElNYXR0ZXJTZWFyY2hSZXN1bHQgfSBmcm9tIFwiLi9JQ29uZmlndXJhdGlvblwiO1xuXG5cbmxldCBjb25uZWN0aW9ucyA9ICRtb2RlbC5Db25uZWN0aW9ucztcbmxldCBjb25maWd1cmF0aW9uOiBDb25maWd1cmF0aW9uVHlwZSA9ICRtb2RlbC5Db25maWd1cmF0aW9uO1xuXG5sZXQgd29ya0l0ZW1JZDogc3RyaW5nIHwgdW5kZWZpbmVkID0gY3R4W2NvbmZpZ3VyYXRpb24ud29ya0l0ZW1JZFZhcmlhYmxlXTtcblxuaWYgKCF3b3JrSXRlbUlkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHByb2dyZXNzIHdvcmsgaXRlbSAtIG5vIHdvcmsgaXRlbSBpZFwiKTtcbn1cblxuZnVuY3Rpb24gdmFsaWRhdGUoKTogYm9vbGVhbiB7XG5cbiAgICBpZiAoIWNvbmZpZ3VyYXRpb24ucGhhc2VGZWF0dXJlKSB7XG4gICAgICAgIGxvZy5FcnJvcihgUGhhc2UgZmVhdHVyZSBpcyBub3Qgc2V0YCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUGhhc2UgZmVhdHVyZSBpcyBub3Qgc2V0YCk7XG4gICAgfVxuXG5cbiAgICAvL2dldCB0aGUgbWF0dGVyXG4gICAgbGV0IHJlcSA9IHtcbiAgICAgICAgXCJzZWFyY2hcIjoge1xuICAgICAgICAgICAgXCJwYWdlXCI6IHsgXCJwYWdlXCI6IDEsIFwicm93c1BlclBhZ2VcIjogMjAgfSxcbiAgICAgICAgICAgIFwic29ydFwiOiB7IFwiZGlyZWN0aW9uXCI6IFwiYXNjZW5kaW5nXCIsIFwib3JkZXJCeVwiOiBcInRpdGxlXCIgfSxcbiAgICAgICAgICAgIFwid29ya0l0ZW1JZHNcIjogW3dvcmtJdGVtSWRdXG4gICAgICAgIH0sXG4gICAgICAgIFwiZW5yaWNoXCI6IFtcbiAgICAgICAgICAgIHsgXCJwYXRoXCI6IFwidGl0bGVcIiB9LFxuICAgICAgICAgICAgeyBcInBhdGhcIjogXCJ0eXBlLnN5c3RlbU5hbWVcIiB9LFxuICAgICAgICAgICAgeyBcInBhdGhcIjogXCJyZWZlcmVuY2VcIiB9LFxuICAgICAgICAgICAgeyBcInBhdGhcIjogXCJwaGFzZS5zeXN0ZW1OYW1lXCIgfVxuICAgICAgICBdXG4gICAgfVxuICAgIGxvZy5JbmZvcm1hdGlvbihcIkdldHRpbmcgbWF0dGVyIGZvciB3b3JrIGl0ZW0gXCIgKyB3b3JrSXRlbUlkKTtcbiAgICBsZXQgaHR0cFJlc3VsdEZpbmRCeVF1ZXJ5OiBIdHRwUmVzdWx0VHlwZTxJTWF0dGVyU2VhcmNoUmVzdWx0PiA9IHNoYXJlZG8uaHR0cC5wb3N0KGAvYXBpL3YxL3B1YmxpYy93b3JrSXRlbS9maW5kQnlRdWVyeWAsIHJlcSk7XG4gICAgbG9nLkluZm9ybWF0aW9uKFwiR290IG1hdHRlciBmb3Igd29yayBpdGVtIFwiICsgd29ya0l0ZW1JZCk7XG4gICAgLy8gbG9nLkluZm9ybWF0aW9uKEpTT04uc3RyaW5naWZ5KGh0dHBSZXN1bHRGaW5kQnlRdWVyeSkpO1xuXG4gICAgaHR0cFJlc3VsdEZpbmRCeVF1ZXJ5LnN1Y2Nlc3MgPSB0cnVlO1xuICAgIGlmICghaHR0cFJlc3VsdEZpbmRCeVF1ZXJ5LnN1Y2Nlc3MpIHtcbiAgICAgICAgbG9nLkVycm9yKFwiRXJyb3JcIik7XG4gICAgICAgIGxvZy5JbmZvcm1hdGlvbihKU09OLnN0cmluZ2lmeShodHRwUmVzdWx0RmluZEJ5UXVlcnkpKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8ganVtcCB0byBwaGFzZSAtIEFQSSByZXR1cm5lZCAnJHtodHRwUmVzdWx0RmluZEJ5UXVlcnkuc3RhdHVzfSdgKTtcbiAgICB9XG5cbiAgICBpZiAoIWh0dHBSZXN1bHRGaW5kQnlRdWVyeS5ib2R5IHx8IGh0dHBSZXN1bHRGaW5kQnlRdWVyeS5ib2R5LnRvdGFsQ291bnQgPT0gMCkge1xuICAgICAgICBsb2cuRXJyb3IoYFdvcmsgaXRlbSAke3dvcmtJdGVtSWR9IG5vdCBmb3VuZGApO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFdvcmsgaXRlbSAke3dvcmtJdGVtSWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGxvZy5JbmZvcm1hdGlvbihgV29yayBpdGVtICR7d29ya0l0ZW1JZH0gZm91bmRgKTtcblxuICAgIGxldCB0eXBlU3lzdGVtTmFtZSA9IGh0dHBSZXN1bHRGaW5kQnlRdWVyeS5ib2R5LnJlc3VsdHNbMF0uZGF0YVtcInR5cGUuc3lzdGVtTmFtZVwiXTtcbiAgICBsZXQgY3VycmVudFBoYXNlID0gaHR0cFJlc3VsdEZpbmRCeVF1ZXJ5LmJvZHkucmVzdWx0c1swXS5kYXRhW1wicGhhc2Uuc3lzdGVtTmFtZVwiXTtcbiAgICBsZXQgdGl0bGUgPSBodHRwUmVzdWx0RmluZEJ5UXVlcnkuYm9keS5yZXN1bHRzWzBdLmRhdGFbXCJ0aXRsZVwiXTtcblxuICAgIGxvZy5JbmZvcm1hdGlvbihgVHlwZSBzeXN0ZW0gbmFtZSBpcyAke3R5cGVTeXN0ZW1OYW1lfWApO1xuICAgIGxvZy5JbmZvcm1hdGlvbihgQ3VycmVudCBwaGFzZSBpcyAke2N1cnJlbnRQaGFzZX1gKTtcbiAgICBsb2cuSW5mb3JtYXRpb24oYFRpdGxlIGlzICR7dGl0bGV9YCk7XG4gICAgbG9nLkluZm9ybWF0aW9uKGBHZXR0aW5nIHBoYXNlcyBvbiB0eXBlICR7dHlwZVN5c3RlbU5hbWV9IHRoYXQgaGF2ZSBmZWF0dXJlIGZsYWcgJHtjb25maWd1cmF0aW9uLnBoYXNlRmVhdHVyZX0gZW5hYmxlZGApO1xuXG4gICAgbGV0IGh0dHBSZXN1bHRGZWF0dXJlOiBIdHRwUmVzdWx0VHlwZTxzdHJpbmdbXT4gPSBzaGFyZWRvLmh0dHAuZ2V0KGAvYXBpL2ZlYXR1cmVmcmFtZXdvcmsvZmxhZ3MvJHtjb25maWd1cmF0aW9uLnBoYXNlRmVhdHVyZX0vJHt0eXBlU3lzdGVtTmFtZX0vZW5hYmxlZFBoYXNlc2ApO1xuXG4gICAgaWYgKCFodHRwUmVzdWx0RmVhdHVyZS5zdWNjZXNzKSB7XG4gICAgICAgIGxvZy5FcnJvcihgRXJyb3IgZ2V0dGluZyBzdWIgZmVhdHVyZXMgZm9yIHR5cGUgJHt0eXBlU3lzdGVtTmFtZX1gKTtcbiAgICAgICAgbG9nLkluZm9ybWF0aW9uKEpTT04uc3RyaW5naWZ5KGh0dHBSZXN1bHRGZWF0dXJlKSk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGp1bXAgdG8gcGhhc2UgLSBBUEkgcmV0dXJuZWQgJyR7aHR0cFJlc3VsdEZlYXR1cmUuc3RhdHVzfSdgKTtcbiAgICB9XG5cbiAgICBpZiAoIWh0dHBSZXN1bHRGZWF0dXJlLmJvZHkgfHwgaHR0cFJlc3VsdEZlYXR1cmUuYm9keS5sZW5ndGggPT0gMCkge1xuICAgICAgICBsb2cuSW5mb3JtYXRpb24oYE5vIGZlYXR1cmVzIGZvdW5kIC0gcmV0dXJuaW5nIGZhbHNlYCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgZm91bmQgPSBodHRwUmVzdWx0RmVhdHVyZS5ib2R5LmZpbmQoKHBoYXNlKSA9PiBwaGFzZS50b0xvd2VyQ2FzZSgpID09PSBjdXJyZW50UGhhc2UudG9Mb3dlckNhc2UoKSk7XG5cbiAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgIGxvZy5JbmZvcm1hdGlvbihgQ3VycmVudCBwaGFzZSAke2N1cnJlbnRQaGFzZX0gaXMgbm90IGluIHRoZSBsaXN0IG9mIHBoYXNlcyB3aXRoIGZlYXR1cmUgJHtjb25maWd1cmF0aW9uLnBoYXNlRmVhdHVyZX1gKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuXG4gICAgbG9nLkluZm9ybWF0aW9uKGBGb3VuZCAke2NvbmZpZ3VyYXRpb24ucGhhc2VGZWF0dXJlfSBvbiBTaGFyZURvICR7d29ya0l0ZW1JZH0gYW5kIGhhcyBiZWVuIHVzZWQgb24gJHtjdXJyZW50UGhhc2V9IHBoYXNlYCk7XG5cbiAgICAvL2NoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCBwaGFzZSBpcyBpbiB0aGUgbGlzdCBvZiBwaGFzZXNcblxuICAgIHJldHVybiB0cnVlO1xuXG59XG5cblxuaWYgKHZhbGlkYXRlKCkgPT09IHRydWUpIHtcbiAgICBsb2cuSW5mb3JtYXRpb24oXCJQaGFzZSBpcyBpbiBsaXMgLSBjYWxsaW5nIGNvbm5lY3Rpb24gZXhpc3RzXCIpO1xuICAgIGlmIChjb25uZWN0aW9ucy5leGlzdHMpIHtcbiAgICAgICAgdHJpZ2dlci5TdWJQcm9jZXNzKGNvbm5lY3Rpb25zLmV4aXN0cy5zdGVwKS5Ob3coKTtcbiAgICB9XG5cbn1cbmVsc2Uge1xuICAgIGxvZy5JbmZvcm1hdGlvbihcIlBoYXNlIGlzIG5vdCBpbiBsaXN0IC0gY2FsbGluZyBjb25uZWN0aW9uIFtub3RFeGlzdHNdXCIpO1xuICAgIGlmIChjb25uZWN0aW9ucy5kb2VzTm90RXhpc3QpIHtcbiAgICAgICAgdHJpZ2dlci5TdWJQcm9jZXNzKGNvbm5lY3Rpb25zLmRvZXNOb3RFeGlzdC5zdGVwKS5Ob3coKTtcbiAgICB9XG4gICAgZWxzZVxuICAgIHtcbiAgICAgICAgbG9nLldhcm5pbmcoXCJObyBjb25uZWN0aW9uIFtub3RFeGlzdHNdIGZvdW5kXCIpO1xuICAgIH1cbn1cblxuIl0sCiAgIm1hcHBpbmdzIjogIjs7O0FBSUEsSUFBSSxjQUFjLE9BQU87QUFDekIsSUFBSSxnQkFBbUMsT0FBTztBQUU5QyxJQUFJLGFBQWlDLElBQUksY0FBYyxrQkFBa0I7QUFFekUsSUFBSSxDQUFDLFlBQVk7QUFDYixRQUFNLElBQUksTUFBTSw2Q0FBNkM7QUFDakU7QUFFQSxTQUFTLFdBQW9CO0FBRXpCLE1BQUksQ0FBQyxjQUFjLGNBQWM7QUFDN0IsUUFBSSxNQUFNLDBC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
